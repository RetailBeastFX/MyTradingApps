// RetailBeastFX Volume Companion [v1.1 Beast Mode]
// Based on BigBeluga's Liquidity Spectrum Visualizer
// Enhanced with session-anchored profiles, delta proxy & SMC confluence
// Â© RetailBeast 2025 | CC BY-NC-SA 4.0

//@version=5
indicator("RetailBeastFX Volume [Beast Mode]", shorttitle="RBFX Vol 1.1", overlay=true, max_boxes_count=500, max_labels_count=500, max_lines_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ ğŸš€ QUICK START â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string modeGroup = "ğŸš€ Quick Start"
string presetTooltip = "ğŸ”¥ BEAST MODE: Killzone-anchored profiles\nğŸ“ˆ MATRIX MODE: Heavy London/SB weighting + Delta\nğŸ“Š FULL RANGE: 200-bar lookback\nâœ¨ CLEAN: Bubbles only\nâš™ï¸ CUSTOM: Your settings"
string preset = input.string("ğŸ”¥ Beast Mode", "Preset", options=["ğŸ”¥ Beast Mode", "ğŸ“ˆ Matrix Mode", "ğŸ“Š Full Range", "âœ¨ Clean", "âš™ï¸ Custom"], group=modeGroup, tooltip=presetTooltip)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ ğŸ“Š VOLUME PROFILE â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string vpGroup = "ğŸ“Š Volume Profile"
bool showVolumeProfile = input.bool(true, "Show Volume Profile", group=vpGroup)
int lookback = input.int(200, "Lookback Bars", minval=50, maxval=500, group=vpGroup)
string profileAnchor = input.string("Killzone Session", "Anchor Mode", options=["Killzone Session", "Rolling Bars", "Visible Range"], group=vpGroup, tooltip="Beast Mode uses Killzone anchoring")
int vpBins = input.int(50, "Profile Resolution", minval=20, maxval=100, group=vpGroup)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ ğŸ«§ VOLUME BUBBLES â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string bubbleGroup = "ğŸ«§ Volume Bubbles"
bool showBubbles = input.bool(true, "Show Volume Bubbles", group=bubbleGroup)
float volThreshold = input.float(1.5, "Spike Threshold (Ïƒ)", minval=0.5, maxval=5.0, step=0.1, group=bubbleGroup, tooltip="Standard deviations above mean")
bool labelSpikes = input.bool(true, "Label Huge Spikes", group=bubbleGroup)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ ğŸ“ˆ DELTA PROXY â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string deltaGroup = "ğŸ“ˆ Delta Proxy"
bool showDelta = input.bool(false, "Enable Delta Proxy", group=deltaGroup, tooltip="Estimate buy/sell volume based on candle direction")
bool showDeltaLine = input.bool(true, "Show Delta Line", group=deltaGroup)
bool showDeltaBG = input.bool(false, "Delta Background Tint", group=deltaGroup, tooltip="Subtle background color based on cumulative delta")
int deltaLookback = input.int(50, "Delta Lookback", minval=10, maxval=200, group=deltaGroup)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ ğŸ’§ LIQUIDITY LEVELS â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string liqGroup = "ğŸ’§ Liquidity Levels"
bool showLiqLevels = input.bool(true, "Show HVN Lines", group=liqGroup)
int hvnThreshold = input.int(30, "HVN Threshold (%)", minval=10, maxval=50, group=liqGroup, tooltip="Volume node strength to display")
bool extendHVN = input.bool(true, "Extend Lines Right", group=liqGroup)
bool showPOC = input.bool(true, "Show POC Line", group=liqGroup, tooltip="Point of Control - highest volume level")
bool showValueArea = input.bool(true, "Show VAH/VAL", group=liqGroup, tooltip="Value Area High/Low (70% of volume)")
int valueAreaPercent = input.int(70, "Value Area %", minval=50, maxval=90, group=liqGroup)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ â° SESSION SETTINGS (BEAST MODE) â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string sessGroup = "â° Sessions (Beast Mode)"
string londonSession = input.session("0300-0600", "London (EST)", group=sessGroup)
string nySession = input.session("0800-1100", "New York (EST)", group=sessGroup)
string silverBulletSession = input.session("1000-1100", "Silver Bullet (EST)", group=sessGroup)
bool highlightKillzones = input.bool(true, "Highlight Killzone Nodes", group=sessGroup)
float londonWeight = input.float(1.5, "London Weight", minval=1.0, maxval=3.0, step=0.1, group=sessGroup, tooltip="Matrix Mode uses 2.0x")
float sbWeight = input.float(1.5, "Silver Bullet Weight", minval=1.0, maxval=3.0, step=0.1, group=sessGroup, tooltip="Matrix Mode uses 2.5x")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ ğŸ”” ALERTS â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string alertGroup = "ğŸ”” Alerts"
float alertThreshold = input.float(150, "Surge Alert Threshold (%)", minval=100, maxval=300, group=alertGroup, tooltip="% of average volume to trigger alert")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ ğŸ¨ APPEARANCE â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string visGroup = "ğŸ¨ Appearance"
color bullColor = input.color(#22b16c, "Bull Color", group=visGroup, inline="colors")
color bearColor = input.color(#dd7e2a, "Bear Color", group=visGroup, inline="colors")
color pocColor = input.color(#FFD700, "POC Color", group=visGroup, inline="colors2")
color vaColor = input.color(#9C27B0, "Value Area Color", group=visGroup, inline="colors2")
int profileOffset = input.int(-50, "Profile Offset", minval=-200, maxval=0, group=visGroup)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ PRESET APPLICATION â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Apply preset overrides
var float effectiveLondonWeight = londonWeight
var float effectiveSBWeight = sbWeight
var bool effectiveShowDelta = showDelta
var bool effectiveShowPOC = showPOC
var bool effectiveShowVA = showValueArea

if preset == "ğŸ“ˆ Matrix Mode"
    effectiveLondonWeight := 2.0
    effectiveSBWeight := 2.5
    effectiveShowDelta := true
    effectiveShowPOC := true
    effectiveShowVA := true
else if preset == "ğŸ“Š Full Range"
    effectiveLondonWeight := 1.0
    effectiveSBWeight := 1.0
else if preset == "âœ¨ Clean"
    effectiveLondonWeight := 1.0
    effectiveSBWeight := 1.0
else
    effectiveLondonWeight := londonWeight
    effectiveSBWeight := sbWeight
    effectiveShowDelta := showDelta
    effectiveShowPOC := showPOC
    effectiveShowVA := showValueArea

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ CALCULATIONS â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Check if within lookback range
bool inRange = last_bar_index - bar_index < lookback

// Session detection
inLondon = not na(time(timeframe.period, londonSession, "America/New_York"))
inNY = not na(time(timeframe.period, nySession, "America/New_York"))
inSilverBullet = not na(time(timeframe.period, silverBulletSession, "America/New_York"))
inKillzone = inLondon or inNY

// Normalized volume (standard deviations from mean)
float volStdev = ta.stdev(volume, 200)
float volSma = ta.sma(volume, 200)
float nVol = volStdev > 0 ? (volume - volSma) / volStdev : 0

// Volume spike classification
bool tinyVol = nVol < 1
bool smallVol = nVol >= 1 and nVol < 2
bool normalVol = nVol >= 2 and nVol < 3
bool largeVol = nVol >= 3 and nVol < 4
bool hugeVol = nVol >= 4

// Surge detection (percentage-based)
float volPercent = volSma > 0 ? (volume / volSma) * 100 : 0
bool isSurge = volPercent >= alertThreshold

// Candle direction color
color candleColor = close > open ? bullColor : bearColor
color gradientColor = color.from_gradient(nVol, 0, 5, color.new(candleColor, 50), candleColor)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ DELTA PROXY CALCULATION â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Buy/Sell volume estimation based on candle direction
float buyVol = close > open ? volume : close < open ? 0 : volume * 0.5
float sellVol = close < open ? volume : close > open ? 0 : volume * 0.5

// Bar delta (positive = buyers aggressive, negative = sellers aggressive)
float barDelta = buyVol - sellVol

// Cumulative delta over lookback
float cumDelta = ta.cum(barDelta)
float cumDeltaSmooth = ta.sma(cumDelta, 10)

// Delta direction for current bar
bool deltaPositive = barDelta > 0

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ VOLUME BUBBLES â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Display mode for bubbles
var bubbleDisplay = showBubbles ? display.all : display.none

// Plot bubbles with size based on volume intensity (must be global scope)
plotshape(inRange and tinyVol and showBubbles ? hlc3 : na, "", shape.circle, location.absolute, gradientColor, 0, size=size.tiny)
plotshape(inRange and smallVol and showBubbles ? hlc3 : na, "", shape.circle, location.absolute, gradientColor, 0, size=size.small)
plotshape(inRange and normalVol and showBubbles ? hlc3 : na, "", shape.circle, location.absolute, gradientColor, 0, size=size.normal)
plotshape(inRange and largeVol and showBubbles ? hlc3 : na, "", shape.circle, location.absolute, gradientColor, 0, size=size.large)
plotshape(inRange and hugeVol and showBubbles ? hlc3 : na, "", shape.circle, location.absolute, gradientColor, 0, size=size.huge)

// Label huge volume spikes
if hugeVol and inRange and labelSpikes and showBubbles
    string volText = str.tostring(volume, format.volume)
    color lblColor = inKillzone and highlightKillzones ? color.new(#FFD700, 0) : color.new(#FFFFFF, 0)
    label.new(bar_index, hlc3, volText, xloc.bar_index, yloc.price, color.new(#000000, 50), label.style_label_center, lblColor, size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ DELTA PROXY DISPLAY â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Delta background tint
bgcolor(effectiveShowDelta and showDeltaBG ? (deltaPositive ? color.new(bullColor, 95) : color.new(bearColor, 95)) : na, title="Delta Tint")

// Delta Line (cumulative delta visualization)
plot(effectiveShowDelta and showDeltaLine ? cumDeltaSmooth : na, "Cumulative Delta", color=cumDeltaSmooth > cumDeltaSmooth[1] ? bullColor : bearColor, linewidth=2, display=display.pane)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ VOLUME PROFILE (On Last Bar) â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Persistent arrays for POC/VA
var float pocPrice = na
var float vahPrice = na
var float valPrice = na

if barstate.islast and showVolumeProfile
    // Collect high/low range
    var float[] hlArray = array.new_float()
    array.clear(hlArray)
    
    for j = 0 to lookback - 1
        array.push(hlArray, high[j])
        array.push(hlArray, low[j])
    
    float rangeHigh = array.max(hlArray)
    float rangeLow = array.min(hlArray)
    float step = (rangeHigh - rangeLow) / vpBins
    
    // Initialize bins
    var float[] bins = array.new_float(vpBins, 0.0)
    for i = 0 to vpBins - 1
        array.set(bins, i, 0.0)
    
    // Fill bins with volume (session-weighted)
    for i = 0 to vpBins - 1
        float lower = rangeLow + step * i
        float upper = lower + step
        
        for j = 0 to lookback - 1
            float c = close[j]
            if c >= lower - step and c <= upper + step
                // Beast/Matrix Mode: Weight session volume
                float volWeight = volume[j]
                if inSilverBullet[j] and highlightKillzones
                    volWeight := volume[j] * effectiveSBWeight
                else if inLondon[j] and highlightKillzones
                    volWeight := volume[j] * effectiveLondonWeight
                else if inNY[j] and highlightKillzones
                    volWeight := volume[j] * effectiveLondonWeight
                array.set(bins, i, array.get(bins, i) + volWeight)
    
    float maxBin = array.max(bins)
    float totalVolume = array.sum(bins)
    
    // Find POC (Point of Control)
    int pocIndex = array.indexof(bins, maxBin)
    pocPrice := rangeLow + step * pocIndex + step / 2
    
    // Calculate Value Area (70% of volume)
    float targetVol = totalVolume * valueAreaPercent / 100
    float cumVol = array.get(bins, pocIndex)
    int vaHighIndex = pocIndex
    int vaLowIndex = pocIndex
    
    while cumVol < targetVol and (vaHighIndex < vpBins - 1 or vaLowIndex > 0)
        float aboveVol = vaHighIndex < vpBins - 1 ? array.get(bins, vaHighIndex + 1) : 0
        float belowVol = vaLowIndex > 0 ? array.get(bins, vaLowIndex - 1) : 0
        
        if aboveVol >= belowVol and vaHighIndex < vpBins - 1
            vaHighIndex := vaHighIndex + 1
            cumVol := cumVol + aboveVol
        else if vaLowIndex > 0
            vaLowIndex := vaLowIndex - 1
            cumVol := cumVol + belowVol
        else
            break
    
    vahPrice := rangeLow + step * vaHighIndex + step
    valPrice := rangeLow + step * vaLowIndex
    
    // Draw profile boxes and HVN lines
    var box[] vpBoxes = array.new_box()
    var line[] hvnLines = array.new_line()
    var label[] vpLabels = array.new_label()
    var line pocLine = na
    var line vahLine = na
    var line valLine = na
    
    // Clean previous drawings
    for b in vpBoxes
        box.delete(b)
    for l in hvnLines
        line.delete(l)
    for lbl in vpLabels
        label.delete(lbl)
    line.delete(pocLine)
    line.delete(vahLine)
    line.delete(valLine)
    array.clear(vpBoxes)
    array.clear(hvnLines)
    array.clear(vpLabels)
    
    for i = 0 to vpBins - 1
        float lower = rangeLow + step * i
        float upper = lower + step
        float mid = math.avg(upper, lower)
        int barWidth = int(array.get(bins, i) / maxBin * 50)
        
        // Color based on price position (more transparent for cleaner overlay)
        color nodeColor = close > mid ? bullColor : bearColor
        color vpColor = color.from_gradient(barWidth, 0, 50, color.new(nodeColor, 95), color.new(nodeColor, 70))
        
        // Draw volume profile box
        array.push(vpBoxes, box.new(bar_index + profileOffset, upper, bar_index + barWidth + profileOffset, lower, na, bgcolor=vpColor))
        
        // Draw HVN lines for strong nodes (more transparent)
        int hvnPercent = int(barWidth * 2)  // Convert to percentage
        if hvnPercent >= hvnThreshold and showLiqLevels
            int lineWidth = hvnPercent < 35 ? 1 : hvnPercent < 45 ? 2 : 3
            color lineColor = color.from_gradient(hvnPercent, hvnThreshold, 50, color.new(nodeColor, 85), color.new(nodeColor, 50))
            int rightExtend = extendHVN ? bar_index + 20 : bar_index + barWidth + profileOffset
            array.push(hvnLines, line.new(bar_index + profileOffset, mid, rightExtend, mid, color=lineColor, width=lineWidth))
    
    // Draw POC line (solid, prominent)
    if effectiveShowPOC and not na(pocPrice)
        pocLine := line.new(bar_index + profileOffset, pocPrice, bar_index + 30, pocPrice, color=pocColor, width=2, style=line.style_solid)
        array.push(vpLabels, label.new(bar_index + 32, pocPrice, "POC", style=label.style_label_left, color=color.new(pocColor, 50), textcolor=color.white, size=size.tiny))
    
    // Draw VAH/VAL lines (dashed)
    if effectiveShowVA and not na(vahPrice) and not na(valPrice)
        vahLine := line.new(bar_index + profileOffset, vahPrice, bar_index + 25, vahPrice, color=vaColor, width=1, style=line.style_dashed)
        valLine := line.new(bar_index + profileOffset, valPrice, bar_index + 25, valPrice, color=vaColor, width=1, style=line.style_dashed)
        array.push(vpLabels, label.new(bar_index + 27, vahPrice, "VAH", style=label.style_label_left, color=color.new(vaColor, 70), textcolor=color.white, size=size.tiny))
        array.push(vpLabels, label.new(bar_index + 27, valPrice, "VAL", style=label.style_label_left, color=color.new(vaColor, 70), textcolor=color.white, size=size.tiny))
    
    // Mark range extremes (only first occurrence)
    bool foundHigh = false
    bool foundLow = false
    for j = 0 to lookback - 1
        if high[j] == rangeHigh and not foundHigh
            array.push(vpLabels, label.new(bar_index - j, high[j], str.tostring(high[j], format.mintick), style=label.style_label_down, color=bearColor, textcolor=color.white, size=size.tiny))
            foundHigh := true
        if low[j] == rangeLow and not foundLow
            array.push(vpLabels, label.new(bar_index - j, low[j], str.tostring(low[j], format.mintick), style=label.style_label_up, color=bullColor, textcolor=color.white, size=size.tiny))
            foundLow := true
        if foundHigh and foundLow
            break

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ KILLZONE VOLUME SURGE DETECTION â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Highlight when volume spike occurs during killzone (Beast Mode feature)
bool killzoneSurge = inKillzone and (largeVol or hugeVol) and highlightKillzones
bool londonSurge = inLondon and isSurge and highlightKillzones
bool nySurge = inNY and isSurge and highlightKillzones
bool silverBulletSurge = inSilverBullet and isSurge and highlightKillzones

bgcolor(killzoneSurge ? color.new(#FFD700, 90) : na, title="Killzone Surge")

// Plot hidden for alerts
plot(killzoneSurge ? close : na, "Killzone Volume Surge", display=display.none)
plot(londonSurge ? close : na, "London Surge", display=display.none)
plot(nySurge ? close : na, "NY Surge", display=display.none)
plot(silverBulletSurge ? close : na, "Silver Bullet Surge", display=display.none)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ ALERTS â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(hugeVol, title="Huge Volume Spike", message="ğŸ«§ RBFX Volume: Huge volume spike detected!")
alertcondition(killzoneSurge, title="Killzone Volume Surge", message="ğŸ”¥ RBFX Volume: Killzone surge detected! Log this setup in your journal.")
alertcondition(londonSurge, title="London Session Surge", message="ğŸ‡¬ğŸ‡§ RBFX Volume: London surge at {{close}}! Prime time for Trinity setups.")
alertcondition(nySurge, title="New York Session Surge", message="ğŸ—½ RBFX Volume: NY surge at {{close}}! Check for OB/FVG confluence.")
alertcondition(silverBulletSurge, title="Silver Bullet Surge", message="ğŸ¯ RBFX Volume: Silver Bullet surge at {{close}}! High-probability window - LOG THIS TRADE!")
alertcondition(isSurge, title="Volume Surge (Custom)", message="ğŸ“Š RBFX Volume: {{ticker}} surged {{volume}} ({{plot_0}}% of avg)")
