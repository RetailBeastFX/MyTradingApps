// RetailBeastFX Volume Companion [v1.2 Quant Mode]
// Â© RetailBeast 2025 | CC BY-NC-SA 4.0
// UPDATES v1.2: Quant Mode (Z-Score Filter), Absorption Detection, VWAP Placement

//@version=5
indicator("RetailBeastFX Volume [v1.2 Quant]", shorttitle="RBFX Vol 1.2", overlay=true, max_boxes_count=500, max_labels_count=500, max_lines_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ ğŸš€ QUICK START â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string modeGroup = "ğŸš€ Quick Start"
string presetTooltip = "ğŸ”¥ BEAST MODE: Killzone-anchored profiles\nğŸ“Š QUANT MODE: Only shows stat-significant volume (>2Ïƒ)\nğŸ“ˆ MATRIX MODE: Heavy London/SB weighting + Delta\nâœ¨ CLEAN: Bubbles only\nâš™ï¸ CUSTOM: Your settings"
string preset = input.string("ğŸ”¥ Beast Mode", "Preset", options=["ğŸ”¥ Beast Mode", "ğŸ“Š Quant Mode", "ğŸ“ˆ Matrix Mode", "ğŸ“Š Full Range", "âœ¨ Clean", "âš™ï¸ Custom"], group=modeGroup, tooltip=presetTooltip)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ ğŸ“Š VOLUME PROFILE â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string vpGroup = "ğŸ“Š Volume Profile"
bool showVolumeProfile = input.bool(true, "Show Volume Profile", group=vpGroup)
int lookback = input.int(200, "Lookback Bars", minval=50, maxval=500, group=vpGroup)
string profileAnchor = input.string("Killzone Session", "Anchor Mode", options=["Killzone Session", "Rolling Bars", "Visible Range"], group=vpGroup)
int vpBins = input.int(50, "Profile Resolution", minval=20, maxval=100, group=vpGroup)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ ğŸ«§ VOLUME BUBBLES â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string bubbleGroup = "ğŸ«§ Volume Bubbles"
bool showBubbles = input.bool(true, "Show Volume Bubbles", group=bubbleGroup)
float volThreshold = input.float(1.5, "Spike Threshold (Ïƒ)", minval=0.5, maxval=5.0, step=0.1, group=bubbleGroup, tooltip="Standard deviations above mean")
bool labelSpikes = input.bool(true, "Label Huge Spikes", group=bubbleGroup)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ ğŸ“‰ QUANT MODE (NEW) â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string quantGroup = "ğŸ“Š Quant Mode"
bool enableQuant = input.bool(false, "Enable Quant Mode", group=quantGroup, tooltip="Filters out low-volume noise. Only shows significant institutional activity.")
float surgeZScore = input.float(2.0, "Surge Z-Score Threshold", minval=1.0, maxval=5.0, step=0.1, group=quantGroup)
bool detectAbs = input.bool(true, "Detect Absorption", group=quantGroup, tooltip="Highlights candles with high volume but small bodies (Reversal Signals)")
float absBodyRatio = input.float(0.4, "Absorption Body Ratio <", minval=0.1, maxval=0.8, step=0.1, group=quantGroup, tooltip="Body size relative to range (0.4 = 40%)")
float absMinZ = input.float(1.5, "Absorption Min Z-Score", minval=1.0, maxval=4.0, step=0.1, group=quantGroup)
bool vwapPlacement = input.bool(false, "VWAP Bubble Placement", group=quantGroup, tooltip="Places bubbles at candle average price instead of high/low")
color absGlowColor = input.color(color.new(#E040FB, 20), "Absorption Glow", group=quantGroup)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ ğŸ“ˆ DELTA PROXY â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string deltaGroup = "ğŸ“ˆ Delta Proxy"
bool showDelta = input.bool(false, "Enable Delta Proxy", group=deltaGroup)
bool showDeltaLine = input.bool(true, "Show Delta Line", group=deltaGroup)
bool showDeltaBG = input.bool(false, "Delta Background Tint", group=deltaGroup)
int deltaLookback = input.int(50, "Delta Lookback", minval=10, maxval=200, group=deltaGroup)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ ğŸ’§ LIQUIDITY LEVELS â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string liqGroup = "ğŸ’§ Liquidity Levels"
bool showLiqLevels = input.bool(true, "Show HVN Lines", group=liqGroup)
int hvnThreshold = input.int(30, "HVN Threshold (%)", minval=10, maxval=50, group=liqGroup)
bool extendHVN = input.bool(true, "Extend Lines Right", group=liqGroup)
bool showPOC = input.bool(true, "Show POC Line", group=liqGroup)
bool showValueArea = input.bool(true, "Show VAH/VAL", group=liqGroup)
int valueAreaPercent = input.int(70, "Value Area %", minval=50, maxval=90, group=liqGroup)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ â° SESSIONS (BEAST MODE) â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string sessGroup = "â° Sessions (Beast Mode)"
string londonSession = input.session("0300-0600", "London (EST)", group=sessGroup)
string nySession = input.session("0800-1100", "New York (EST)", group=sessGroup)
string silverBulletSession = input.session("1000-1100", "Silver Bullet (EST)", group=sessGroup)
bool highlightKillzones = input.bool(true, "Highlight Killzone Nodes", group=sessGroup)
float londonWeight = input.float(1.5, "London Weight", minval=1.0, maxval=3.0, step=0.1, group=sessGroup)
float sbWeight = input.float(1.5, "Silver Bullet Weight", minval=1.0, maxval=3.0, step=0.1, group=sessGroup)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ ğŸ”” ALERTS & VISUALS â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
string visGroup = "ğŸ¨ Appearance"
float alertThreshold = input.float(150, "Surge Alert Threshold (%)", minval=100, maxval=300, group="ğŸ”” Alerts")

// BRAND IDENTITY COLORS (LOCKED)
color bullColor = input.color(#39FF14, "Bull Color (Beast Green)", group=visGroup, inline="c1")
color bearColor = input.color(#FF3131, "Bear Color (Trap Red)", group=visGroup, inline="c1")
color pocColor = input.color(#FFFFFF, "POC Color", group=visGroup, inline="c2")
color vaColor = input.color(#808080, "Value Area Color", group=visGroup, inline="c2")
int profileOffset = input.int(-50, "Profile Offset", group=visGroup)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ PRESET LOGIC â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var float effLondonWeight = londonWeight
var float effSBWeight = sbWeight
var bool effQuant = enableQuant
var float effSurgeZ = surgeZScore

if preset == "ğŸ“Š Quant Mode"
    effQuant := true
    effSurgeZ := 2.0
else if preset == "ğŸ“ˆ Matrix Mode"
    effLondonWeight := 2.0
    effSBWeight := 2.5
else if preset == "ğŸ“Š Full Range"
    effLondonWeight := 1.0
    effSBWeight := 1.0
else if preset == "âœ¨ Clean"
    effLondonWeight := 1.0
    effSBWeight := 1.0
else
    effLondonWeight := londonWeight
    effSBWeight := sbWeight
    effQuant := enableQuant
    effSurgeZ := surgeZScore

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ CALCULATIONS â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Range & Sessions
bool inRange = last_bar_index - bar_index < lookback
inLondon = not na(time(timeframe.period, londonSession, "America/New_York"))
inNY = not na(time(timeframe.period, nySession, "America/New_York"))
inSilverBullet = not na(time(timeframe.period, silverBulletSession, "America/New_York"))
inKillzone = inLondon or inNY

// Z-Score Calculation (Quant Mode Core)
float volStdev = ta.stdev(volume, 200)
float volSma = ta.sma(volume, 200)
float zScore = volStdev > 0 ? (volume - volSma) / volStdev : 0

// Standard Spike Classification
bool tinyVol = zScore < 1
bool smallVol = zScore >= 1 and zScore < 2
bool normalVol = zScore >= 2 and zScore < 3
bool largeVol = zScore >= 3 and zScore < 4
bool hugeVol = zScore >= 4

// QUANT MODE FILTER
// If enabled, hide everything below the Z-Score threshold
bool quantFilterPassed = effQuant ? (zScore >= effSurgeZ) : true

// ABSORPTION DETECTION
// High Volume + Small Body = Institutional Absorption
float candleRange = high - low
float bodySize = math.abs(close - open)
float bodyRatio = candleRange > 0 ? bodySize / candleRange : 1.0
bool isAbsorption = detectAbs and (zScore >= absMinZ) and (bodyRatio < absBodyRatio)

// Surge Percentage
float volPercent = volSma > 0 ? (volume / volSma) * 100 : 0
bool isSurge = volPercent >= alertThreshold

// Colors & Visuals
color candleCol = close > open ? bullColor : bearColor
color gradCol = isAbsorption ? absGlowColor : color.from_gradient(zScore, 0, 5, color.new(candleCol, 60), candleCol)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ PLOTTING BUBBLES â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// VWAP Placement Logic (Snaps bubble to HLC3 if enabled, otherwise floats)
float bubbleY = vwapPlacement ? hlc3 : (close > open ? high : low)

// Only plot if: 1. In Range, 2. Bubbles Enabled, 3. Quant Filter Passed
bool showThisBubble = inRange and showBubbles and quantFilterPassed

// Absorption Glow (Background)
bgcolor(isAbsorption and showThisBubble ? color.new(absGlowColor, 80) : na, title="Absorption Highlight")

// Bubbles - VWAP Placement (location.absolute at HLC3)
plotshape(showThisBubble and tinyVol and vwapPlacement ? bubbleY : na, "", shape.circle, location.absolute, gradCol, 0, size=size.tiny)
plotshape(showThisBubble and smallVol and vwapPlacement ? bubbleY : na, "", shape.circle, location.absolute, gradCol, 0, size=size.small)
plotshape(showThisBubble and normalVol and vwapPlacement ? bubbleY : na, "", shape.circle, location.absolute, gradCol, 0, size=size.normal)
plotshape(showThisBubble and largeVol and vwapPlacement ? bubbleY : na, "", shape.circle, location.absolute, gradCol, 0, size=size.large)
plotshape(showThisBubble and hugeVol and vwapPlacement ? bubbleY : na, "", shape.circle, location.absolute, gradCol, 0, size=size.huge)

// Bubbles - Standard Placement (above bullish / below bearish)
plotshape(showThisBubble and tinyVol and not vwapPlacement and close > open ? high : na, "", shape.circle, location.abovebar, gradCol, 0, size=size.tiny)
plotshape(showThisBubble and smallVol and not vwapPlacement and close > open ? high : na, "", shape.circle, location.abovebar, gradCol, 0, size=size.small)
plotshape(showThisBubble and normalVol and not vwapPlacement and close > open ? high : na, "", shape.circle, location.abovebar, gradCol, 0, size=size.normal)
plotshape(showThisBubble and largeVol and not vwapPlacement and close > open ? high : na, "", shape.circle, location.abovebar, gradCol, 0, size=size.large)
plotshape(showThisBubble and hugeVol and not vwapPlacement and close > open ? high : na, "", shape.circle, location.abovebar, gradCol, 0, size=size.huge)

plotshape(showThisBubble and tinyVol and not vwapPlacement and close <= open ? low : na, "", shape.circle, location.belowbar, gradCol, 0, size=size.tiny)
plotshape(showThisBubble and smallVol and not vwapPlacement and close <= open ? low : na, "", shape.circle, location.belowbar, gradCol, 0, size=size.small)
plotshape(showThisBubble and normalVol and not vwapPlacement and close <= open ? low : na, "", shape.circle, location.belowbar, gradCol, 0, size=size.normal)
plotshape(showThisBubble and largeVol and not vwapPlacement and close <= open ? low : na, "", shape.circle, location.belowbar, gradCol, 0, size=size.large)
plotshape(showThisBubble and hugeVol and not vwapPlacement and close <= open ? low : na, "", shape.circle, location.belowbar, gradCol, 0, size=size.huge)

// Text Labels for Huge Spikes
if hugeVol and inRange and labelSpikes and showBubbles and quantFilterPassed
    string volText = str.tostring(volume, format.volume)
    color lblColor = inKillzone and highlightKillzones ? #FFD700 : #FFFFFF
    label.new(bar_index, bubbleY, volText, xloc.bar_index, yloc.price, color.new(#000000, 100), label.style_label_center, lblColor, size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ DELTA PROXY PANE â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
float buyVol = close > open ? volume : close < open ? 0 : volume * 0.5
float sellVol = close < open ? volume : close > open ? 0 : volume * 0.5
float barDelta = buyVol - sellVol
float cumDelta = ta.cum(barDelta)
float cumDeltaSmooth = ta.sma(cumDelta, 10)

bgcolor(showDelta and showDeltaBG ? (barDelta > 0 ? color.new(bullColor, 95) : color.new(bearColor, 95)) : na, title="Delta Tint")
plot(showDelta and showDeltaLine ? cumDeltaSmooth : na, "Cumulative Delta", color=cumDeltaSmooth > cumDeltaSmooth[1] ? bullColor : bearColor, linewidth=2, display=display.pane)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ VOLUME PROFILE (Logic Preserved) â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// (This section handles the Right-Side Profile logic from v1.1)
var float pocPrice = na
var float vahPrice = na
var float valPrice = na

if barstate.islast and showVolumeProfile
    var float[] hlArray = array.new_float()
    array.clear(hlArray)
    for j = 0 to lookback - 1
        array.push(hlArray, high[j])
        array.push(hlArray, low[j])
    
    float rangeHigh = array.max(hlArray)
    float rangeLow = array.min(hlArray)
    float step = (rangeHigh - rangeLow) / vpBins
    
    var float[] bins = array.new_float(vpBins, 0.0)
    for i = 0 to vpBins - 1
        array.set(bins, i, 0.0)
        
    for i = 0 to vpBins - 1
        float lower = rangeLow + step * i
        float upper = lower + step
        for j = 0 to lookback - 1
            float c = close[j]
            if c >= lower - step and c <= upper + step
                float volWeight = volume[j]
                if inSilverBullet[j] and highlightKillzones
                    volWeight := volume[j] * effSBWeight
                else if inLondon[j] and highlightKillzones
                    volWeight := volume[j] * effLondonWeight
                else if inNY[j] and highlightKillzones
                    volWeight := volume[j] * effLondonWeight
                array.set(bins, i, array.get(bins, i) + volWeight)

    float maxBin = array.max(bins)
    float totalVolume = array.sum(bins)
    int pocIndex = array.indexof(bins, maxBin)
    pocPrice := rangeLow + step * pocIndex + step / 2
    
    // Value Area Calc
    float targetVol = totalVolume * valueAreaPercent / 100
    float cumVol = array.get(bins, pocIndex)
    int vaHighIndex = pocIndex
    int vaLowIndex = pocIndex
    
    while cumVol < targetVol and (vaHighIndex < vpBins - 1 or vaLowIndex > 0)
        float aboveVol = vaHighIndex < vpBins - 1 ? array.get(bins, vaHighIndex + 1) : 0
        float belowVol = vaLowIndex > 0 ? array.get(bins, vaLowIndex - 1) : 0
        if aboveVol >= belowVol and vaHighIndex < vpBins - 1
            vaHighIndex := vaHighIndex + 1
            cumVol := cumVol + aboveVol
        else if vaLowIndex > 0
            vaLowIndex := vaLowIndex - 1
            cumVol := cumVol + belowVol
        else
            break
            
    vahPrice := rangeLow + step * vaHighIndex + step
    valPrice := rangeLow + step * vaLowIndex

    // Drawing
    var box[] vpBoxes = array.new_box()
    var line[] hvnLines = array.new_line()
    var label[] vpLabels = array.new_label()
    var line pocLine = na
    var line vahLine = na
    var line valLine = na
    
    for b in vpBoxes
        box.delete(b)
    for l in hvnLines
        line.delete(l)
    for lbl in vpLabels
        label.delete(lbl)
    line.delete(pocLine)
    line.delete(vahLine)
    line.delete(valLine)
    array.clear(vpBoxes)
    array.clear(hvnLines)
    array.clear(vpLabels)
    
    for i = 0 to vpBins - 1
        float lower = rangeLow + step * i
        float upper = lower + step
        float mid = math.avg(upper, lower)
        int barWidth = int(array.get(bins, i) / maxBin * 50)
        color nodeColor = close > mid ? bullColor : bearColor
        color vpColor = color.from_gradient(barWidth, 0, 50, color.new(nodeColor, 95), color.new(nodeColor, 70))
        array.push(vpBoxes, box.new(bar_index + profileOffset, upper, bar_index + barWidth + profileOffset, lower, na, bgcolor=vpColor))
        
        int hvnPercent = int(barWidth * 2)
        if hvnPercent >= hvnThreshold and showLiqLevels
            int lineWidth = hvnPercent < 35 ? 1 : hvnPercent < 45 ? 2 : 3
            color lineColor = color.from_gradient(hvnPercent, hvnThreshold, 50, color.new(nodeColor, 85), color.new(nodeColor, 50))
            int rightExtend = extendHVN ? bar_index + 20 : bar_index + barWidth + profileOffset
            array.push(hvnLines, line.new(bar_index + profileOffset, mid, rightExtend, mid, color=lineColor, width=lineWidth))

    if showPOC and not na(pocPrice)
        pocLine := line.new(bar_index + profileOffset, pocPrice, bar_index + 30, pocPrice, color=pocColor, width=2, style=line.style_solid)
        array.push(vpLabels, label.new(bar_index + 32, pocPrice, "POC", style=label.style_label_left, color=color.new(pocColor, 50), textcolor=color.white, size=size.tiny))
        
    if showValueArea and not na(vahPrice) and not na(valPrice)
        vahLine := line.new(bar_index + profileOffset, vahPrice, bar_index + 25, vahPrice, color=vaColor, width=1, style=line.style_dashed)
        valLine := line.new(bar_index + profileOffset, valPrice, bar_index + 25, valPrice, color=vaColor, width=1, style=line.style_dashed)
        array.push(vpLabels, label.new(bar_index + 27, vahPrice, "VAH", style=label.style_label_left, color=color.new(vaColor, 70), textcolor=color.white, size=size.tiny))
        array.push(vpLabels, label.new(bar_index + 27, valPrice, "VAL", style=label.style_label_left, color=color.new(vaColor, 70), textcolor=color.white, size=size.tiny))

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆâ–ˆ ALERTS â–ˆâ–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
alertcondition(hugeVol and quantFilterPassed, title="Huge Quant Surge", message="ğŸ“Š RBFX Quant: Significant volume surge detected!")
alertcondition(isAbsorption, title="Absorption Detected", message="ğŸ”® RBFX: Absorption detected! Possible reversal.")
